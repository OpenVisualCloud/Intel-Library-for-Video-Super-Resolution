name: scan-codeql-workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '15 0 * * *'

env:
  BUILD_TYPE: "Release"
  PREFIX_DIR: /usr/local
  DEBIAN_FRONTEND: "noninteractive"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number ||  github.sha }}
  cancel-in-progress: true

jobs:
  analyze:
    name: 'scan-codeql-workflow-analyze'
    runs-on: ${{ matrix.runner-os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        runner-os: [ 'ubuntu-22.04' ]
    permissions:
      actions: read
      security-events: write
    defaults:
      run:
        shell: bash
    steps:
    - name: 'Harden Runner'
      uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
      with:
        egress-policy: audit

    - name: 'Checkout repository'
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

    - name: 'Get RAISR prerequisites and set-up git'
      run: |
        sudo apt update -y
        sudo apt install -y sudo git wget curl pkg-config bash tar zip unzip make
        mkdir -p "${{ github.workspace }}/build"
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"

    - name: 'Build RAISR prerequisites and install'
      working-directory: "${{ github.workspace }}/build"
      run: |
        "${{ github.workspace }}/scripts/01_pull_resources.sh"
        "${{ github.workspace }}/scripts/02_install_prerequisites.sh" "${{ github.workspace }}/build/raisr.tar.gz"

    - name: 'Initialize CodeQL action'
      uses: github/codeql-action/init@b611370bb5703a7efb587f9d136a52ea24c5c38c # v3.25.11
      with:
        languages: "c-cpp"
        config-file: "${{ github.workspace }}/.github/codeql/codeql-config.yml"

    - name: 'Build RAISR source library'
      working-directory: "${{ github.workspace }}/build"
      run: |
        "${{ github.workspace }}/scripts/03_build_raisr_ffmpeg.sh" "${{ github.workspace }}/build/raisr/Video-Super-Resolution-Library"
        "${{ github.workspace }}/build.sh"

    - name: 'Perform CodeQL Analysis'
      uses: github/codeql-action/analyze@b611370bb5703a7efb587f9d136a52ea24c5c38c # v3.25.11
      with:
        category: "/language:c-cpp"
